# Beginning



## 基本概論

在編寫自動程式前，必須理解以下的概念。本篇章著重概念上的知識，不是介紹指令的使用方法以及如何建立自動計劃，詳情請參考[指令文檔](API_Document.html)以及[教程](Tutorials.html)。

### 指令

指令是指完成某一硬件操作。很多指令都是耗時的，例如**向前行**、**提高升降台**等等指令都需要時間達成目標。一個指令內部分為多個階段進行，包含啟動階段、執行階段和結束階段。

啟動：包括設置目標參數、開啟馬達  
執行：調整馬達速度、檢測目標是否達成  
結束：關閉馬達、重設參數

### 什麼是同步，異步？

#### 同步

程序指令一行一行執行，上一行不執行完，下一行就不會被執行；如果上一行卡住了遲遲不結束（阻塞了），那麼整塊代碼全部卡住。  
例子：同一條路軌三架列車，要等前面先走完。

#### 異步：

程序指令一行一行順序啟動，啟動後跳出執行下一行，指令的內容會在第二條線程執行，第二條線程卡住了，不影響後面的啟動，整塊代碼不會被卡住。 例子：三架列車，分岔口分開三條路軌獨立行駛，不會互相影響。

**考慮以下代碼:**

```cpp
forward(120) await;
lift(46) await;
```

以上代碼執行次序為: 先執行**向前行**指令，等待指令完成後再執行**升降台**指令，因此指令是同步執行。

```cpp
forward(120) ;
lift(46);
```

以上代碼執行次序為: 先啟動**向前行**指令，啟動後跳出並啟動下一行**升降台**指令，因此指令是異步執行。

**同步執行下的指令流程圖**

![Imgur](https://i.imgur.com/6r2iftp.png)

**異步執行下的指令流程圖**

![Imgur](https://i.imgur.com/89vRknc.png)

### await 關鍵字

在CMAPI裏，所有指令都是異步進行，即是說指令啟動後便會跳出執行下一行，如果你想該指令在執行下一行指令之前先完成，我們便需要增加await關鍵字。  
await 關鍵字加在指令的後面，以宣告該指令的執行時段將會被等待。

#### 例子1

**考慮以下代碼:**

```cpp
forward(120) await;
lift(46);
```

代碼表示先執行**向前行**指令，等待指令完成後再啟動下一行**升降台**指令，升降台啟動後便會跳出。

**各指令執行的順序時間軸**

|  |  |
| :--- | :--- |
| forward | ■■■■■■■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀⠀ |
| lift | ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀■■■■■■■■■■ |

#### 例子2

**考慮以下代碼:**

```cpp
forward(120) await;
lift(46);
claw(100);
```

代碼表示先執行**向前行**指令，等待指令完成後再啟動下一行**升降台**指令，升降台啟動後便會跳出啟動下一行**機械鉗**指令。

**各指令執行的順序時間軸**

|  |  |
| :--- | :--- |
| forward | ■■■■■■■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀⠀ |
| lift | ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀■■■■■■■■■■ |
| claw | ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀■■■■■■■■⠀⠀ |

#### 例子3

**考慮以下代碼:**

```cpp
forward(120);
lift(46) await;
claw(100);
```

代碼表示先啟動**向前行**指令，啟動後便會跳出執行下一行**升降台**指令，等待**升降台**指令完成後再啟動下一行**機械鉗**指令。

**各指令執行的順序時間軸**

|  |  |
| :--- | :--- |
| forward | ■■■■■■■■■■■■■■■■⠀⠀ |
| lift | ■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀ |
| claw | ⠀⠀⠀⠀⠀⠀⠀⠀⠀■■■■■■■■⠀ |

### 等待直至靜止

使用`waitUntilAboveSettled`指令可以等待直接所有指令進入結束狀態並停止，無論在這之前的指令是同步或異步進行。

**考慮以下代碼:**

```cpp
forward(120);
lift(46);

waitUntilAboveSettled();

claw(100);
```

代碼表示先啟動**向前行**指令，啟動後再啟動下一行**升降台**指令，升降台啟動後便會跳出。 等待以上指令\(兩個\)都完成後，啟動下一行**機械鉗**指令。

**各指令執行的順序時間軸**

|  |  |
| :--- | :--- |
| forward | ■■■■■■■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀ |
| lift | ■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ |
| claw | ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀■■■■■■■■⠀ |

### 等待直到目標條件

使用`waitUntil`指令可以設置自定義的條件，條件以一個匿名函式所表達，等待直至當中的條件為`True`。

**考慮以下代碼:**

```cpp
forward(120);

waitUntil([]()->bool{
    return mtrLeftF.get_power() > 50;
});

claw(100);
```

代碼表示先啟動**向前行**指令，啟動後便會跳出等待**左前輪馬達的力度大於50**，再啟動下一行**機械鉗**指令。

亦可以使用以下語法糖執行相同效果

```cpp
forward(120);

waiting(mtrLeftF.get_power() > 50);

claw(100);
```

### 同源動作衝突

**考慮以下代碼:**

```cpp
forward(60);
turnLeft(90);
```

兩種動作都是控制機械人底盤的指令，如果兩個動作一起異步進行，應該會發生什麼事？轉左會取替向前的動作嗎？抑或發生錯誤無法停止？

此錯誤命名為**同源動作衝突**（Same-Origin Action Conflict），意思是說控制同一組馬達或控制相同部件的指令嘗試在同一時間進行，由於機械人不能一直向前並且轉左，因此系統會強制轉左指令先等待向前指令完成，再隨後執行，並且報出警告，程式中應該對同源動作衝突保持警惕，並且善用此帶來的優勢。

**各指令執行的順序時間軸**

|  |  |
| :--- | :--- |
| forward | ■■■■■■■■■■■■■⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ |
| turnLeft | ——————————■■■■■■■■■■■■⠀⠀⠀⠀ |

另外編寫程式時，應該注意可能導致衝突發生的的危險情況：  
**考慮以下代碼:**

```cpp
forward(90);
lift(80) await;
turnLeft(90);
```

此代碼表示向前行駛以及升降架指令一同執行，升降架指令完成後，不顧及向前指令完成與否，啟動向左的指令。升降架指令如果比向前指令更快完成，便會產生衝突，你可以使用以下方式迴避問題：

```cpp
lift(80);
forward(90)

waitUntilAboveSettled();

turnLeft(90);
```

### 指令限時功能

指令限時可以讓一定區域的指令在所設定的時間來執行，如果時間超過，接下來屬於CMAPI的指令將會自動停止並跳過，但你所自定義的代碼及呼叫的函式並不會跳過。

**考慮以下代碼:**

```cpp
limitStart(3600);

forward(120) await;
lift(46) await;

limitEnd();
```

代碼表示先執行**向前行**指令，再執行下一行**升降台**指令，如果兩個指令的執行途中大於3600毫秒，將會停止並直接跳到limitEnd後面再執行其他程序。

亦可以使用以下語法糖執行相同效果

```cpp
limit(3600,
 forward(120) await;
 lift(46) await;
);
```

限時功能只能夠計算線程阻塞總共多少時間，例如以下代碼:

```cpp
limit(3600,
 forward(120) await;
 lift(46);
);
```

以上代碼**升降台**指令並不耗時，因此啟動後便會跳出，並不計算在指令限時功能內。

### isTimeup 指令

你亦可以使用`isTimeup`指令判斷現在進行或者上一次的限制是否超過 **考慮以下代碼:**

```cpp
limit(3600,
 forward(120) await;
 lift(46) await;
);
if(isTimeup()){
    backward(20) await;
}
```

代碼表示執行**向前行**以及**升降台**指令，如果兩個指令的執行途中大於3600毫秒，將會停止並執行**向後行**指令。

### 角度單位

#### 陀螺儀原始讀值

由機械人程式**起始角度**開始計算，陀螺儀每次旋轉一圈數值便會歸零，即是說，讀取得到的數值永遠是在-3599~3599範圍內，一般不會使用原始數值，因為數值不方便處理，不能計算多於１圈的旋轉，難以有效計算真實的機械人角度。

10 = 1度

| 向右旋轉 | 向左旋轉 |
| :--- | :--- |
| ![](https://imgur.com/9IxlXn6.png) | ![](https://imgur.com/mmQIV7C.png) |

或者以數線表達：

```text
                       < 向左旋轉 | 向右旋轉 >
         0           0           0           0           0
...<-----|-----------|-----------|-----------|-----------|----->...
               ↑           ↑           ↑          ↑
             -1800       -1800       +1800      +1800
```

你可以使用以下程式碼取得數值：

```cpp
pros::ADIGyro gyro (portGyro);
int raw = gyro.get_value();
```

#### 陀螺儀角度值

經過處理的陀螺儀原始讀值，**自動程式開始時**機械人面向的**起始角度**開始計算，左轉正數，右轉負數，數值可以計算超過一圈，不會歸零。

10 = 1度

| 向右旋轉 | 向左旋轉 |
| :--- | :--- |
| ![](https://imgur.com/zAa7kzi.png) | ![](https://imgur.com/SMljrCU.png) |

你可以使用以下程式碼取得數值：

```cpp
int value = GyroValue;
```

#### 絕對方位角

絕對方位角是指 **自動程式開始時**機械人面向的**起始角度** 與 **現時**機械人**面向角** 之間的**角度差**。數值永遠不會負數，並且在0~3599範圍內，**起始角度**永遠為0，左方2700，右方900 。

10 = 1度

![](https://imgur.com/ItEDf6r.png)

你可以使用以下程式碼取得數值：

```cpp
// GyroValue 除以3600後的餘數 
int azimuth = GyroValue % 3600;
```

